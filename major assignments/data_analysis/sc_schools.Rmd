---
title: "SC Schools"
author: "Greg Morton"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(rio)
library(stringr)
library(collapse)


```

## Discipline in South Carolina Schools 

Received the daata as a *very interestingly formatted* xlsx file.  

Data contains an incident number, date, location, time, a description of the behavior, and a description of the actions taken in response.  

I'm honestly not 100% sure what direction they were gonna take the story in.  My challenge is to make meaningful observations and find interesting trends within data I know very little about.  Should be fun.  

First step is loading in the data.  This excel file was clearly meant to be read by humans and not computers.  

```{r cars}
knitr::include_graphics(rep("images/messed_up_excel.png"))
```

## Reading in the Data

My first instict here was to try the read_xlsx function from the 'readxl' package.  Unfortunately R (as expected) had a hard time understanding the table formatting.  

As an example let's take a look at incident #29091.  

These four rows all constitute one incident in wich a student was suspended for one day for 'disrupting class', and 'refusal to obey/defiant'. 


The next challenge is to find a way to consolidate the content of these rows into 1
```{r pressure, echo=FALSE}
sc_xlsx_18 <- read_xlsx("data/ware shoals- FOI All Incidents  2018 through 2021 No offenders.xlsx", sheet = 4)

sc_xlsx_18 <- sc_xlsx_18 %>%
  rename(incident_id = "Incident ID",
         incident_date = "Incident Date")  %>%
  mutate(incident_id = as.character(incident_id)) 


  

sc_xlsx_18[c(533,534,535,536),]
```

Here we go.  This solution, in addition to doing some basic cleaning, 
```{r}

sc_schools_clean_18<- sc_xlsx_18 %>%
  filter(!is.na(Behaviors)) %>%
  fill(incident_id, incident_date, School, Time) %>%
  mutate(incident_id = ifelse(is.na(incident_id), 
                       lead(incident_id, 1), incident_id)) %>%
  mutate(inc_id = as.character(incident_id)) 



sc_schools_clean_18 %>%
  filter(incident_id == "29091")


```

Seems fine BUT this method actually doesn't account for a few cases where "Actions" are placed in a different column than "Behaviors".  

```{r, echo = F}

sc_xlsx_18 %>%
  filter(is.na(Actions)) %>%
  .[49,]

```

What a bummer.  But this actually ended up being a pretty easy fix using the 'if_any' function

```{r, echo = F}
sc_schools_clean_18 <- sc_xlsx_18 %>%
  filter(if_any(everything(), ~ !is.na(.))) %>%
  fill(incident_id, incident_date, School, Time) 

# Case 29091.  Second "Behavior" was missing an "Action"

sc_schools_clean_18 %>%
  filter(incident_id == "29091")

# Incident 28538.  Second "Action" was missing a "Behavior"

sc_schools_clean_18 %>%
  filter(incident_id == "28538")

sc_schools_clean_18

```

Now I repeat this process for each other year and merge the data 

```{r, echo = F}

#2019
sc_xlsx_19 <- read_xlsx("data/ware shoals- FOI All Incidents  2018 through 2021 No offenders.xlsx", sheet = 3) 

sc_schools_clean_19 <- sc_xlsx_19 %>%
  rename(incident_id = "Incident ID",
         incident_date = "Incident Date")  %>%
  mutate(incident_id = as.character(incident_id)) %>%
  filter(if_any(everything(), ~ !is.na(.))) %>%
  fill(incident_id, incident_date, School, Time) 

#2020 
sc_xlsx_20 <- read_xlsx("data/ware shoals- FOI All Incidents  2018 through 2021 No offenders.xlsx", sheet = 2) 

sc_schools_clean_20 <- sc_xlsx_20 %>%
  rename(incident_id = "Incident ID",
         incident_date = "Incident Date")  %>%
  mutate(incident_id = as.character(incident_id)) %>%
  filter(if_any(everything(), ~ !is.na(.))) %>%
  fill(incident_id, incident_date, School, Time) 
  
#2021
sc_xlsx_21 <- read_xlsx("data/ware shoals- FOI All Incidents  2018 through 2021 No offenders.xlsx", sheet = 1) 

sc_schools_clean_21 <- sc_xlsx_21 %>%
  rename(incident_id = "Incident ID",
         incident_date = "Incident Date")  %>%
  mutate(incident_id = as.character(incident_id)) %>%
  filter(if_any(everything(), ~ !is.na(.))) %>%
  fill(incident_id, incident_date, School, Time) 

sc_schools_all <- full_join(sc_schools_clean_18, sc_schools_clean_19) %>%
  full_join(sc_schools_clean_20) %>%
  full_join(sc_schools_clean_21)


```

```{r}
sc_schools_all %>%
  group_by(School) %>%
  count() 

sc_schools_all %>%
  group_by(Location) %>%
  count(sort = T)

sc_schools_all %>%
  group_by(Actions) %>%
  count(sort = T)

sc_schools_all %>%
  group_by(Behaviors) %>%
  count(sort = T)

sc_schools_all %>%
  group_by(Time) %>%
  count(sort = T)

sc_schools_all %>%
  group_by(incident_date) %>%
  summarise(n = n()) %>%
  ggplot() +
  geom_line(aes(x = incident_date, y = n))

```


**Takeaways**:

The data actually seems kind of incomplete.  For one because there's still more in pdf form that I have to load with OpenRefine.  But also because the last incident of every year in the data (including the data yet unloaded) is 11/20, a few months before the end of the school year.  


The data is also very mundane in its present form.  It's hardly news that most discipline is happening during school hours and resulting from classroom incidents.  I'm hoping that more context on the schools will start to bring it to life by allowing me to do a little more analysis of the relationship between variables.  

Feeling a liiiiiiittle bit nervous that I won't find anything noteworthy but I'll give this another week or two before I start ringing alarm bells.  